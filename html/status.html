<!DOCTYPE html>
<html lang="no">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Status - Jelsa Jordbær</title>
  <link rel="icon" href="../favicon2.png" type="image/png" />
  <link rel="stylesheet" href="style.css" />
  <style>
    .status-indicator {
      width: 20px;
      height: 20px;
      border-radius: 50%;
      margin-right: 1rem;
    }

    .green { background-color: #28a745; }
    .yellow { background-color: #ffc107; }
    .red { background-color: #dc3545; }

    #admin-panel {
      margin-top: 2rem;
      border-top: 1px solid #ccc;
      padding-top: 1rem;
    }

    #admin-panel input, #admin-panel select {
      margin: 0.5rem 0;
      display: block;
      width: 100%;
      padding: 0.5rem;
    }

    .hidden { display: none; }

    .button {
      padding: 0.5rem 1rem;
      background-color: #007bff;
      color: white;
      border: none;
      cursor: pointer;
      border-radius: 5px;
    }

    .button:hover {
      background-color: #0056b3;
    }

    /* Fikset indikator nede i høyre hjørne */
    .floating-indicator {
      position: fixed;
      bottom: 20px;
      right: 20px;
      z-index: 1000;
      display: flex;
      align-items: center;
      background: white;
      padding: 8px 12px;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.2);
      font-size: 0.9rem;
    }

    .location-status {
      display: flex;
      align-items: center;
      margin-bottom: 1rem;
      font-size: 1.2rem;
    }

    .info-section {
      background: white;
      padding: 2rem;
      border-radius: 10px;
      max-width: 600px;
      margin: 2rem auto;
    }
  </style>
</head>
<body>
  <header>
    <h1>Jelsa Jordbær</h1>
    <p>"Dei får bein å gå på"</p>
  </header>

  <nav>
    <ul>
      <li><a href="../index.html">Hjem</a></li>
      <li><a href="omoss.html">Om oss</a></li>
      <li><a href="produkt.html">Produkter</a></li>
      <li><a href="kontakt.html">Kontakt</a></li>
      <li><a href="status.html">Status</a></li>
    </ul>
  </nav>

    <div class="image-container">
      <h2>Status for utsalgssteder</h2>
      <div class="location-status">
        <div id="status-haugesund" class="status-indicator"></div>
        <span>Haugesund - </span><span id="status-text-haugesund" class="status-text"></span>
      </div>
      <div class="location-status">
        <div id="status-akra" class="status-indicator"></div>
        <span>Åkra - </span><span id="status-text-akra" class="status-text"></span>
      </div>
      <div class="location-status">
        <div id="status-sand" class="status-indicator"></div>
        <span>Sand - </span><span id="status-text-sand" class="status-text"></span>
      </div>
      

      <button class="button" onclick="toggleAdmin()">For jordbærselgere</button>

      <div id="admin-panel" class="hidden">
        <h3>Oppdater status</h3>
        <input type="text" id="token" placeholder="Passord">
        <label for="haugesund">Haugesund</label>
        <select id="haugesund">
          <option>åpent</option>
          <option>lite bær igjen</option>
          <option>stengt</option>
        </select>
        <label for="akra">Åkra</label>
        <select id="akra">
          <option>åpent</option>
          <option>lite bær igjen</option>
          <option>stengt</option>
        </select>
        <label for="sand">Sand</label>
        <select id="sand">
          <option>åpent</option>
          <option>lite bær igjen</option>
          <option>stengt</option>
        </select>
        <button class="button" onclick="lagreStatus()">Lagre status</button>
        <button class="button" onclick="loggUt()" style="background-color:#dc3545; margin-top: 10px;">Logg ut</button>
      </div>
    </div>
  <script>
    const time = String(Date.now());
    const gistRawUrl = 'https://gist.githubusercontent.com/JelsaJordberr/26826facd1e67fbd0c421936f405df2c/raw/90c897085c66a2390e576ec4879475554671206e/status.json';
    const gistId = '26826facd1e67fbd0c421936f405df2c';
    const gistFilename = 'status.json';
    const gistApiUrl = `https://api.github.com/gists/${gistId}`+ `?time=${time}`;

    const statusMapping = {
      "åpent": "green",
      "lite bær igjen": "yellow",
      "stengt": "red"
    };

    function oppdaterStatus(id, status) {
        const indicatorEl = document.getElementById(id);
        const textEl = document.getElementById("status-text-" + id.split("-")[1]);

        indicatorEl.className = "status-indicator " + (statusMapping[status.toLowerCase()] || 'red');

        if (textEl) {
            textEl.textContent = status;
        }
    }


    function toggleAdmin() {
      const adminPanel = document.getElementById('admin-panel');
      adminPanel.classList.toggle('hidden');
    }

    function hentStatus() {
      const time = String(Date.now());
      fetch(gistRawUrl + `?time=${time}`)
        .then(response => response.json())
        .then(data => {
          oppdaterStatus('status-haugesund', data.haugesund);
          oppdaterStatus('status-akra', data.akra);
          oppdaterStatus('status-sand', data.sand);
          oppdaterStatus('flytende-status', data.haugesund); // <- For indikator nederst

          document.getElementById('haugesund').value = data.haugesund;
          document.getElementById('akra').value = data.akra;
          document.getElementById('sand').value = data.sand;
        })
        .catch(err => console.error("Feil ved henting av status:", err));
    }

    function hentLokalToken() {
      const token = localStorage.getItem('gistToken');
      if (token) {
        document.getElementById('token').value = token;
      }
    }

    function lagreTokenHvisNytt(token) {
      if (token && localStorage.getItem('gistToken') !== token) {
        localStorage.setItem('gistToken', token);
      }
    }

    function loggUt() {
      localStorage.removeItem('gistToken');
      alert("Du er logget ut.");
      location.reload();
    }

    function lagreStatus() {
      const token = document.getElementById('token').value.trim();
      if (!token) {
        alert("Du må fylle inn et GitHub-token.");
        return;
      }

      lagreTokenHvisNytt(token);

      const data = {
        haugesund: document.getElementById('haugesund').value,
        akra: document.getElementById('akra').value,
        sand: document.getElementById('sand').value
      };

      fetch(gistApiUrl, {
        method: 'PATCH',
        headers: {
          'Authorization': 'token ' + token,
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({
          files: {
            [gistFilename]: {
              content: JSON.stringify(data, null, 2)
            }
          }
        })
      })
      .then(res => {
        if (!res.ok) throw new Error("Feil ved oppdatering");
        alert("Status oppdatert!");
        hentStatus();
      })
      .catch(err => {
        console.error(err);
        alert("Klarte ikke å oppdatere Gist.");
      });
    }
    // Init
    hentLokalToken();
    hentStatus();
    setInterval(hentStatus, 20000); // Hent status hvert 20. sekund

  </script>
</body>
</html>
